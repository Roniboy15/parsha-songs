<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Parsha-Songs</title>
    <meta name="theme-color" content="#C76A28">

    <!-- Favicon / tab & device icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="logo-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo-16.png">
    <!-- Optional: classic .ico (can include multiple sizes) -->
    <link rel="shortcut icon" href="favicon.ico">
    <!-- Optional: Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <!-- Optional: high-res for Android -->
    <link rel="manifest" href="site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600&family=Gentium+Plus:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .loading-dots {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        .loading-dots span {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-700);
            display: block;
            animation: ldots 1s infinite ease-in-out;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: .2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: .4s;
        }

        @keyframes ldots {

            0%,
            80%,
            100% {
                opacity: .2;
                transform: scale(.7);
            }

            40% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>

    <!-- Open Graph meta tags for link previews -->
    <meta property="og:title" content="Make the Parasha Sing" />
    <meta property="og:description"
        content="Find and share songs that connect to weekly Torah portions (Parshiot), Haftarah readings, and any chapter of Tanach" />
    <meta property="og:url" content="https://parsha-songs.onrender.com" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Parsha Songs" />
    <meta property="og:image" content="https://parsha-songs.onrender.com/og-image.png?v=1" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Parsha Songs ‚Äì Make the Parasha Sing" />




    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Make the Parasha Sing" />
    <meta name="twitter:description"
        content="Find and share songs that connect to weekly Torah portions (Parshiot), Haftarah readings, and any chapter of Tanach" />
    <meta name="twitter:image" content="https://parsha-songs.onrender.com/logo.png" />

    <!-- General meta tags -->
    <meta name="description"
        content="Find and share songs that connect to weekly Torah portions (Parshiot), Haftarah readings, and any chapter of Tanach" />
    <link rel="canonical" href="https://parsha-songs.onrender.com/">
    <!-- optional -->
    <meta name="keywords" content="Torah, Parsha, Haftarah, Tanach, Songs, Jewish music">
</head>

<body>
    <header class="site-header">
        <div class="site-title">
            <h1 class="main-title">Make the Parasha Sing</h1>
            <p class="site-subtitle">Connect songs to Parshiot, Haftarot, and Tanach.</p>
            <div id="total-songs" class="songs-count"></div>
        </div>

        <img src="logo.png" alt="Logo" class="site-logo" />
    </header>

    <section class="current-parasha-section">
        <h2>Pick this week's parasha</h2>
        <button id="btn-current">Load parasha</button>
        <p id="current-parasha"></p>
    </section>

    <section>
        <h2>Or pick from list</h2>
        <select id="parsha-list"></select>

        <div style="margin-top: 1rem;">
            <label>
                <input type="radio" name="target-kind" value="parasha" checked />
                Link to parasha
            </label>
            <label>
                <input type="radio" name="target-kind" value="haftarah" />
                Link to haftarah
            </label>
        </div>

        <div id="haftarah-wrap" style="display: none; margin-top: 0.5rem;">
            <label for="haftarah-list">Haftarah:</label>
            <select id="haftarah-list"></select>
        </div>
    </section>

    <!-- NEW: Tanach selector section -->
    <section>
        <h2>Or pick any Tanach book</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <label for="tanach-book-list">Book:</label>
            <select id="tanach-book-list" style="min-width:220px;"></select>

            <label for="tanach-chapter-list">Chapter:</label>
            <select id="tanach-chapter-list" style="min-width:120px;"></select>

            <button id="tanach-go" title="Load songs for this chapter">Load</button>
        </div>
        <p id="tanach-load-status" style="color:#666; margin-top:6px;"></p>
    </section>

    <section>
        <h2 id="connect-song-title">Connect a new song</h2>
    <input id="song-title" placeholder="Song name" />
    <input id="song-link" placeholder="Link (optional)" />
    <input id="verse-ref" placeholder="Chapter and verse (optional)" />
        <button id="btn-save">Save</button>

        <!-- Flash message (success) -->
        <div id="flash" role="status" aria-live="polite"
            style="display:none;margin-top:8px;padding:8px 12px;background:#e6ffed;border:1px solid #2ea44f;color:#1b6e3b;border-radius:6px;">
        </div>
    </section>

    <section>
        <h2 id="songs-section-title">Songs for this selection</h2>
        <table id="links-table" cellpadding="4">
            <thead>
                <tr>
                    <th>Song</th>
                    <th>Link</th>
                    <th>Verse</th>
                    <th id="delete-header" style="display:none">Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="links-info"></p>
        <div id="links-loading" class="loading-dots" aria-live="polite" style="display:none">
            <span></span><span></span><span></span>
        </div>
    </section>

    <section>
        <h3>Admin</h3>
        <p id="admin-status"></p>
        <input id="admin-token-input" type="password" placeholder="Admin token" />
        <button id="btn-admin-login">Login</button>
        <button id="btn-admin-logout" style="display:none">Logout</button>
        <button id="btn-stats" style="display:none">üìä Visit Stats</button>

        <div id="moderation-section" style="display:none; margin-top:1rem; border-top:1px solid #ddd; padding-top:1rem;">
            <h4 style="margin-top:0;">Pending submissions</h4>
            <p style="margin:0 0 0.75rem 0; color:#555;">Review songs awaiting approval. Approve to publish or decline to keep them hidden.</p>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <button id="btn-refresh-pending" type="button">Refresh pending</button>
                <span id="pending-status" style="color:#555;"></span>
            </div>
            <div style="overflow-x:auto; margin-top:0.75rem;">
                <table id="pending-table" style="width:100%; border-collapse:collapse; display:none;">
                    <thead>
                        <tr style="text-align:left; border-bottom:1px solid #ccc;">
                            <th style="padding:6px 8px;">Song</th>
                            <th style="padding:6px 8px;">Target</th>
                            <th style="padding:6px 8px;">Info</th>
                            <th style="padding:6px 8px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- floating help button -->
    <button id="help-btn" class="help-button" aria-label="Help">?</button>

    <!-- help modal -->
    <div id="help-modal" class="modal" aria-hidden="true" style="display:none">
        <div class="modal-content help-modal-content" role="dialog" aria-modal="true" aria-label="About this app">
            <button id="help-modal-close" class="modal-close" aria-label="Close">√ó</button>
            <div class="help-header">
                <h2>About Parsha Songs</h2>
                <div class="help-verse">
                    <div class="verse-hebrew">◊ï◊ê◊™◊ù ◊õ◊™◊ë◊ï ◊ú◊õ◊ù ◊ê◊™ ◊î◊©◊ô◊®◊î ◊î◊ñ◊ê◊™</div>
                    <div class="verse-english">"Now therefore write this song for yourselves"</div>
                    <div class="verse-source">Devarim 31:19</div>
                </div>
            </div>
            <div class="help-content">
                <p><strong>What is this?</strong></p>
                <p>This app helps you find and share songs that connect to weekly Torah portions (Parshiot), their
                    Haftarah readings, and any chapter across Tanach.</p>

                <p><strong>How to use:</strong></p>
                <ol>
                    <li><strong>Select a Parasha:</strong> Choose from the dropdown (e.g., "Bereshit", "Noach"); you can switch between Torah and Haftarah.</li>
                    <li><strong>Or pick a Tanach chapter:</strong> Select any book and chapter to browse or add songs beyond the weekly readings.</li>
                    <li><strong>Browse existing songs:</strong> See what others have already shared.</li>
                    <li><strong>Add your own:</strong> Share a song and optionally include a verse reference (e.g., "1:22").</li>
                </ol>

                <p><strong>Tips:</strong></p>
                <ul>
                    <li>Include YouTube, Spotify, or other music links when possible</li>
                    <li>Add verse references to show the connection (e.g. "1:22")</li>
                    <li>Help build a musical companion to Torah study!</li>
                </ul>
                <p><strong>Questions or feedback?</strong>
                    <button type="button" class="contact-email" data-email-local="106,97,114,111,110,46,49,49,49" data-email-domain="104,111,116,109,97,105,108,46,99,111,109" style="background:none;border:none;color:#0066cc;text-decoration:underline;cursor:pointer;font:inherit;padding:0;">Email me</button>
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- ADD: simple flash helper so showFlash() exists ---
        function showFlash(message, type = "success", ms = 6000) {
            const el = document.getElementById("flash");
            if (!el) return;
            el.textContent = message;
            el.style.display = "block";
            el.style.background = type === "error" ? "#ffe6e6" : "#e6ffed";
            el.style.borderColor = type === "error" ? "#cc0000" : "#2ea44f";
            el.style.color = type === "error" ? "#8a0000" : "#1b6e3b";
            clearTimeout(el.__t);
            el.__t = setTimeout(() => (el.style.display = "none"), ms);
        }

        let ALL_PARSHIOT = [];
        let selectedParashaId = null;
        let selectedKind = "parasha";
        let selectedHaftarahId = null;
        let selectedDisplayName = "";
    let IS_ADMIN = false;
    const MIN_LINK_LOAD_MS = 900;
    const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

        // NEW: Tanach state
        let TANACH_BOOKS = [];
        let selectedBookId = null;     // normalized id
        let selectedBookTitle = null;  // English title
        let selectedChapter = null;

        let currentLinksAbort = null;

        // set UI mode: "parasha" | "haftarah" | "tanach"
        function setKind(kind) {
            selectedKind = kind;
            // sync radios
            document.querySelectorAll('input[name="target-kind"]').forEach((r) => {
                r.checked = r.value === kind;
            });
            // toggle haftarah controls
            const wrap = document.getElementById("haftarah-wrap");
            if (wrap) wrap.style.display = kind === "haftarah" ? "block" : "none";
            updateSelectedDisplayName();
        }

        // Smoothly scroll the viewport to the songs list section
        function scrollToSongsList() {
            const anchor = document.getElementById("songs-section-title") || document.getElementById("links-table");
            if (anchor && typeof anchor.scrollIntoView === "function") {
                anchor.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        }

        function beginLinksLoad() {
            const tbody = document.querySelector("#links-table tbody");
            if (tbody) tbody.innerHTML = "";
            const info = document.getElementById("links-info");
            if (info) info.textContent = "";
            const loader = document.getElementById("links-loading");
            if (loader) loader.style.display = "inline-flex";
            scrollToSongsList();
        }

        // 1) load parshiot and build dropdown
        async function loadParshiot() {
            const res = await fetch("/api/parshiot");
            const parshiot = await res.json();
            ALL_PARSHIOT = parshiot;

            const byBook = {};
            parshiot.forEach((p) => {
                if (!byBook[p.book]) byBook[p.book] = [];
                byBook[p.book].push(p);
            });

            const order = ["bereshit", "shemot", "vayikra", "bamidbar", "devarim"];
            const select = document.getElementById("parsha-list");
            select.innerHTML = "";

            order.forEach((book) => {
                const list = byBook[book];
                if (!list) return;
                const og = document.createElement("optgroup");
                og.label = list[0].book_en;
                list.sort((a, b) => a.order_index - b.order_index);
                list.forEach((p) => {
                    const opt = document.createElement("option");
                    opt.value = p.id;
                    opt.textContent = p.name_en;
                    og.appendChild(opt);
                });
                select.appendChild(og);
            });

            // default selection
            if (parshiot.length) {
                selectedParashaId = parshiot[0].id;
                setKind("parasha"); // ensure we start in parasha mode
                beginLinksLoad();
                populateHaftarot(selectedParashaId);
                await loadLinksForCurrentSelection();
            }

            // when user changes parasha from list: force back to parasha mode
            select.addEventListener("change", async (e) => {
                selectedParashaId = e.target.value;
                setKind("parasha");
                beginLinksLoad();
                populateHaftarot(selectedParashaId);
                await loadLinksForCurrentSelection();
                scrollToSongsList();
            });
        }

        // NEW: load tanach books and populate dropdowns
        async function loadTanachBooks() {
            const status = document.getElementById("tanach-load-status");
            try {
                status.textContent = "Loading Tanach books‚Ä¶";
                const res = await fetch("/api/tanach/books");
                if (!res.ok) throw new Error("Failed to load Tanach list");
                TANACH_BOOKS = await res.json();

                const bookSel = document.getElementById("tanach-book-list");
                const chapSel = document.getElementById("tanach-chapter-list");
                bookSel.innerHTML = "";
                chapSel.innerHTML = "";

                if (!Array.isArray(TANACH_BOOKS) || TANACH_BOOKS.length === 0) {
                    status.textContent = "No Tanach books available.";
                    return;
                }

                TANACH_BOOKS.forEach((b) => {
                    const opt = document.createElement("option");
                    opt.value = b.id;
                    // Show only the book title (no chapter counts in label)
                    opt.textContent = b.title_en;
                    bookSel.appendChild(opt);
                });

                selectedBookId = TANACH_BOOKS[0].id;
                selectedBookTitle = TANACH_BOOKS[0].title_en;
                fillChapterSelect(TANACH_BOOKS[0].chapters);
                status.textContent = "";
            } catch (err) {
                console.error(err);
                status.textContent = "Failed to load Tanach data.";
            }
        }

                // removed: no longer auto-fill verse input with chapter (was confusing)

        // helper: apply selection (updates headers + loads list)
        async function applyTanachSelectionUpdate() {
          selectedKind = "tanach";
                    // hide haftarah UI when in tanach mode
                    const wrap = document.getElementById("haftarah-wrap");
                    if (wrap) wrap.style.display = "none";
                    // do not auto-fill verse; ensure field remains as user left it
          updateSelectedDisplayName();
          beginLinksLoad();
                    await loadLinksForCurrentSelection();
                    scrollToSongsList();
        }

        function fillChapterSelect(chapters) {
            const chapSel = document.getElementById("tanach-chapter-list");
            chapSel.innerHTML = "";
            for (let i = 1; i <= chapters; i++) {
                const opt = document.createElement("option");
                opt.value = String(i);
                opt.textContent = String(i);
                chapSel.appendChild(opt);
            }
            // set selectedChapter to the first available; do not prefill verse
            selectedChapter = parseInt(chapSel.value || "1", 10);
        }

        // Add this new function
        function updateSelectedDisplayName() {
            const parasha = ALL_PARSHIOT.find((p) => p.id === selectedParashaId);
            if (selectedKind === "tanach") {
                const book = TANACH_BOOKS.find((b) => b.id === selectedBookId);
                const bookName = book?.title_en || selectedBookTitle || "Selected book";
                selectedDisplayName = selectedChapter
                    ? `${bookName} ch. ${selectedChapter}`
                    : `${bookName}`;
                updateSectionTitle();
                return;
            }

            if (!parasha) {
                selectedDisplayName = "this selection";
                updateSectionTitle();
                return;
            }

            if (selectedKind === "parasha") {
                selectedDisplayName = `Parashat ${parasha.name_en}`;
            } else if (selectedKind === "haftarah") {
                const haftarah = parasha.haftarot?.diaspora?.find(h => h.id === selectedHaftarahId);
                if (haftarah) {
                    selectedDisplayName = `${haftarah.name} (Haftarah for ${parasha.name_en})`;
                } else {
                    selectedDisplayName = `Haftarah for ${parasha.name_en}`;
                }
            }
            updateSectionTitle();
        }

        function updateSectionTitle() {
            const title = document.getElementById("songs-section-title");
            title.textContent = `Songs for ${selectedDisplayName}`;
            const connectTitle = document.getElementById("connect-song-title");
            connectTitle.textContent = `Connect a new song to ${selectedDisplayName}`;
        }

        function populateHaftarot(parashaId) {
            const wrap = document.getElementById("haftarah-wrap");
            const sel = document.getElementById("haftarah-list");
            sel.innerHTML = "";

            const parasha = ALL_PARSHIOT.find((p) => p.id === parashaId);
            if (!parasha) return;

            const list =
                parasha.haftarot?.diaspora && parasha.haftarot.diaspora.length
                    ? parasha.haftarot.diaspora
                    : [];

            list.forEach((h) => {
                const opt = document.createElement("option");
                opt.value = h.id;
                opt.textContent = h.name;
                sel.appendChild(opt);
            });

            selectedHaftarahId = list.length ? list[0].id : null;
            updateSelectedDisplayName(); // Add this call
            wrap.style.display =
                selectedKind === "haftarah" && list.length ? "block" : "none";

            // Add haftarah selection change listener
            sel.onchange = async (e) => {
                selectedHaftarahId = e.target.value;
                beginLinksLoad();
                updateSelectedDisplayName();
                await loadLinksForCurrentSelection();
            };
        }

        // 3) load current parasha from backend/he bcal
        document.getElementById("btn-current").addEventListener("click", async () => {
            // ensure we‚Äôre in parasha mode when user clicks this
            setKind("parasha");
            beginLinksLoad();
            const res = await fetch("/api/current-reading");
            const data = await res.json();
            const p = document.getElementById("current-parasha");

            if (!data.ok) {
                p.textContent = "No parasha in the next 7 days.";
                return;
            }

            const currentId = data.parasha.id;
            const currentName = data.parasha.name_en;

            p.textContent = `This Shabbat: ${currentName}`;
            selectedParashaId = currentId;

            const select = document.getElementById("parsha-list");
            const option = Array.from(select.options).find((opt) => opt.value === currentId);
            if (option) select.value = currentId;

            updateSelectedDisplayName();
            populateHaftarot(selectedParashaId);
            await loadLinksForCurrentSelection();
            scrollToSongsList();
        });

        // Radio buttons (parasha / haftarah)
        document
            .querySelectorAll('input[name="target-kind"]')
            .forEach((input) => {
                input.addEventListener("change", async (e) => {
                    // switching the radio away from tanach should show parasha/haftarah data
                    setKind(e.target.value);
                    if (!selectedParashaId) {
                        // pick first parasha if none selected yet
                        if (ALL_PARSHIOT.length) selectedParashaId = ALL_PARSHIOT[0].id;
                    }
                    beginLinksLoad();
                    populateHaftarot(selectedParashaId);
                    await loadLinksForCurrentSelection();
                });
            });

        // NEW: Tanach selectors behavior (update immediately on change)
        document.getElementById("tanach-book-list").addEventListener("change", async (e) => {
            const id = e.target.value;
            const book = TANACH_BOOKS.find((b) => b.id === id);
            if (!book) return;
            selectedBookId = id;
            selectedBookTitle = book.title_en;
            fillChapterSelect(book.chapters);
            await applyTanachSelectionUpdate();
        });

        document.getElementById("tanach-chapter-list").addEventListener("change", async (e) => {
            selectedChapter = parseInt(e.target.value, 10);
            await applyTanachSelectionUpdate();
        });

        document.getElementById("tanach-go").addEventListener("click", async () => {
            if (!selectedBookId || !selectedChapter) return;
            await applyTanachSelectionUpdate();
        });

        // 6) load links for current parasha/kind or tanach
        async function loadLinksForCurrentSelection() {
            const startedAt = performance.now();
            if (currentLinksAbort) currentLinksAbort.abort();
            currentLinksAbort = new AbortController();
            const { signal } = currentLinksAbort;
            beginLinksLoad();

            let rows = [];
            let totalData = { total: 0 };
            try {
                const totalRes = await fetch(`/api/total-songs?ts=${Date.now()}` , { signal, cache: "no-store" });
                totalData = await totalRes.json();

                if (selectedKind === "tanach") {
                    const params = new URLSearchParams({
                        book_id: selectedBookId,
                        chapter: String(selectedChapter || 1),
                    });
                    const res = await fetch(`/api/links-tanach?${params.toString()}&ts=${Date.now()}` , { signal, cache: "no-store" });
                    rows = await res.json();
                } else {
                    const params = new URLSearchParams({ parasha_id: selectedParashaId });
                    params.set("target_kind", selectedKind);
                    const res = await fetch(`/api/links?${params.toString()}&ts=${Date.now()}` , { signal, cache: "no-store" });
                    rows = await res.json();
                }
            } catch (err) {
                const loader = document.getElementById("links-loading");
                if (loader) loader.style.display = "none";
                if (err.name === "AbortError") return;
                console.error("Load failed:", err);
                const info = document.getElementById("links-info");
                if (info) info.textContent = "Fehler beim Laden.";
                return;
            } finally {
                currentLinksAbort = null;
            }

            if (signal.aborted) {
                return;
            }

            const elapsed = performance.now() - startedAt;
            if (elapsed < MIN_LINK_LOAD_MS) {
                await sleep(MIN_LINK_LOAD_MS - elapsed);
            }

            const totalSongs = document.getElementById("total-songs");
            totalSongs.textContent = `${totalData.total} songs connected so far`;

            const tbody = document.querySelector("#links-table tbody");
            if (!tbody) {
                const loader = document.getElementById("links-loading");
                if (loader) loader.style.display = "none";
                return;
            }
            tbody.innerHTML = "";

            const isAdmin = IS_ADMIN;

            rows.forEach((row) => {
                const tr = document.createElement("tr");

                const tdSong = document.createElement("td");
                tdSong.textContent = row.song_title;
                tdSong.className = "col-song";
                tdSong.title = row.song_title;
                tr.appendChild(tdSong);

                const tdUrl = document.createElement("td");
                if (row.song_url) {
                    const a = document.createElement("a");
                    a.href = row.song_url;
                    let displayUrl = row.song_url;
                    if (displayUrl.length > 40) displayUrl = displayUrl.substring(0, 37) + "...";
                    a.textContent = displayUrl;
                    a.target = "_blank";
                    a.rel = "noopener";
                    a.style.color = "#0066cc";
                    a.style.textDecoration = "underline";
                    tdUrl.appendChild(a);
                    tdUrl.title = row.song_url;
                } else {
                    tdUrl.textContent = "-";
                    tdUrl.style.color = "#999";
                }
                tr.appendChild(tdUrl);

                const tdVerse = document.createElement("td");
                const fullVerse = row.verse_ref || "";
                const tdVerseTextMax = 30;
                if (fullVerse) {
                    if (fullVerse.length > tdVerseTextMax) {
                        const short = fullVerse.slice(0, tdVerseTextMax - 3) + "...";
                        tdVerse.textContent = short;
                        tdVerse.title = "Click to read full text";
                        tdVerse.className = "col-verse clickable-verse";
                        tdVerse.addEventListener("click", () => openVerseModal(fullVerse));
                    } else {
                        tdVerse.textContent = fullVerse;
                        tdVerse.title = fullVerse;
                        tdVerse.className = "col-verse";
                    }
                } else {
                    tdVerse.textContent = "";
                    tdVerse.className = "col-verse";
                }
                tr.appendChild(tdVerse);

                // Delete column (only if admin)
                if (isAdmin) {
                    const tdDel = document.createElement("td");
                    const btn = document.createElement("button");
                    btn.textContent = "üóë";
                    btn.addEventListener("click", async () => {
                        if (!confirm("Delete this link?")) return;
                        const res = await fetch(`/api/links/${row.id}`, {
                            method: "DELETE",
                        });
                        if (!res.ok) {
                            const d = await res.json().catch(() => ({}));
                            alert("Delete failed: " + (d.error || res.status));
                            return;
                        }
                        await loadLinksForCurrentSelection();
                    });
                    tdDel.appendChild(btn);
                    tr.appendChild(tdDel);
                }

                tbody.appendChild(tr);
            });

            // Update delete header visibility
            const deleteHeader = document.getElementById("delete-header");
            if (deleteHeader) deleteHeader.style.display = isAdmin ? "" : "none";

            const loader = document.getElementById("links-loading");
            if (loader) loader.style.display = "none";
            const info = document.getElementById("links-info");
            if (info && rows.length === 0) info.textContent = "No songs found.";
        }



        // modal markup (inserted once; functions below will use these elements)
        // place this markup at the end of the existing <script> or right before </body>
        const modalHtml = `
        <div id="verse-modal" class="modal" aria-hidden="true" style="display:none">
          <div class="modal-content" role="dialog" aria-modal="true" aria-label="Full verse text">
            <button id="verse-modal-close" class="modal-close" aria-label="Close">√ó</button>
            <pre id="verse-modal-text"></pre>
          </div>
        </div>
        `;
        // append modal to body if not present
        if (!document.getElementById("verse-modal")) {
            document.body.insertAdjacentHTML("beforeend", modalHtml);
        }

        // modal control functions
        function openVerseModal(text) {
            const modal = document.getElementById("verse-modal");
            const pre = document.getElementById("verse-modal-text");
            pre.textContent = text;
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
            document.getElementById("verse-modal-close").focus();
        }
        function closeVerseModal() {
            const modal = document.getElementById("verse-modal");
            modal.style.display = "none";
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        }
        // close handlers
        document.addEventListener("click", (e) => {
            const modal = document.getElementById("verse-modal");
            if (!modal) return;
            if (e.target && e.target.id === "verse-modal-close") closeVerseModal();
            if (e.target === modal) closeVerseModal();
        });
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeVerseModal();
        });

        function labelForTarget(row) {
            if (!row) return "";
            if (row.target_kind === "parasha") {
                const match = ALL_PARSHIOT.find((p) => p.id === row.parasha_id);
                return match ? match.name_en : row.parasha_id;
            }
            if (row.target_kind === "haftarah") {
                const parasha = ALL_PARSHIOT.find((p) => p.id === row.parasha_id);
                const haftarot = parasha?.haftarot?.diaspora || [];
                const match = haftarot.find((h) => h.id === row.target_id);
                if (match?.name) return `${parasha?.name_en || row.parasha_id} ‚Äì ${match.name}`;
                return `${parasha?.name_en || row.parasha_id} ‚Äì Haftarah`;
            }
            if (row.target_kind === "tanach" && row.target_id) {
                const [bookId, chapter] = row.target_id.split(":");
                const book = TANACH_BOOKS.find((b) => b.id === bookId);
                if (book) return `${book.title_en} ${chapter || ""}`.trim();
                return row.target_id;
            }
            return row.target_kind;
        }

        function formatDateTime(ts) {
            if (!ts) return "";
            const date = new Date(ts);
            if (Number.isNaN(date.getTime())) return ts;
            return date.toLocaleString();
        }

        function clearPendingModeration() {
            const table = document.getElementById("pending-table");
            const tbody = table?.querySelector("tbody");
            if (tbody) tbody.innerHTML = "";
            if (table) table.style.display = "none";
            const statusEl = document.getElementById("pending-status");
            if (statusEl) statusEl.textContent = "";
        }

        async function loadPendingModeration() {
            const section = document.getElementById("moderation-section");
            if (!section) return;
            if (!IS_ADMIN) {
                section.style.display = "none";
                clearPendingModeration();
                return;
            }

            section.style.display = "";
            const statusEl = document.getElementById("pending-status");
            const table = document.getElementById("pending-table");
            const tbody = table?.querySelector("tbody");
            if (!table || !tbody) return;

            if (statusEl) statusEl.textContent = "Loading pending songs‚Ä¶";
            table.style.display = "none";
            tbody.innerHTML = "";

            try {
                const res = await fetch(`/api/admin/links/pending?ts=${Date.now()}`, { cache: "no-store" });
                if (!res.ok) {
                    const body = await res.json().catch(() => ({}));
                    if (statusEl) statusEl.textContent = `Failed to load pending songs (${body.error || res.status}).`;
                    return;
                }
                const rows = await res.json();
                if (!Array.isArray(rows) || rows.length === 0) {
                    if (statusEl) statusEl.textContent = "No pending submissions.";
                    return;
                }

                if (statusEl) statusEl.textContent = `${rows.length} pending ${rows.length === 1 ? "song" : "songs"}.`;
                table.style.display = "table";

                rows.forEach((row) => {
                    const tr = document.createElement("tr");
                    tr.style.borderBottom = "1px solid #eee";

                    const songCell = document.createElement("td");
                    songCell.style.padding = "6px 8px";
                    const titleDiv = document.createElement("div");
                    titleDiv.textContent = row.song_title || "(no title)";
                    titleDiv.style.fontWeight = "600";
                    songCell.appendChild(titleDiv);
                    if (row.song_url) {
                        const linkEl = document.createElement("a");
                        linkEl.href = row.song_url;
                        linkEl.target = "_blank";
                        linkEl.rel = "noopener";
                        linkEl.textContent = row.song_url;
                        linkEl.style.fontSize = "0.85rem";
                        linkEl.style.wordBreak = "break-all";
                        songCell.appendChild(linkEl);
                    }
                    tr.appendChild(songCell);

                    const targetCell = document.createElement("td");
                    targetCell.style.padding = "6px 8px";
                    targetCell.textContent = labelForTarget(row);
                    tr.appendChild(targetCell);

                    const infoCell = document.createElement("td");
                    infoCell.style.padding = "6px 8px";
                    infoCell.style.fontSize = "0.85rem";
                    infoCell.style.color = "#444";
                    const infoLines = [];
                    if (row.added_by) infoLines.push(`Added by: ${row.added_by}`);
                    if (row.verse_ref) infoLines.push(`Verse: ${row.verse_ref}`);
                    infoLines.push(`Submitted: ${formatDateTime(row.added_at)}`);
                    infoLines.forEach((line) => {
                        const div = document.createElement("div");
                        div.textContent = line;
                        infoCell.appendChild(div);
                    });
                    tr.appendChild(infoCell);

                    const actionsCell = document.createElement("td");
                    actionsCell.style.padding = "6px 8px";
                    const wrap = document.createElement("div");
                    wrap.style.display = "flex";
                    wrap.style.gap = "6px";

                    const approveBtn = document.createElement("button");
                    const rejectBtn = document.createElement("button");

                    approveBtn.textContent = "Approve";
                    approveBtn.addEventListener("click", async () => {
                        approveBtn.disabled = true;
                        rejectBtn.disabled = true;
                        try {
                            await handleModerationAction(row.id, "approve");
                        } catch (err) {
                            alert("Approve failed: " + (err.message || err));
                            approveBtn.disabled = false;
                            rejectBtn.disabled = false;
                        }
                    });
                    wrap.appendChild(approveBtn);

                    rejectBtn.textContent = "Decline";
                    rejectBtn.addEventListener("click", async () => {
                        if (!confirm("Decline this song?")) return;
                        approveBtn.disabled = true;
                        rejectBtn.disabled = true;
                        try {
                            await handleModerationAction(row.id, "reject");
                        } catch (err) {
                            alert("Decline failed: " + (err.message || err));
                            approveBtn.disabled = false;
                            rejectBtn.disabled = false;
                        }
                    });
                    wrap.appendChild(rejectBtn);

                    actionsCell.appendChild(wrap);
                    tr.appendChild(actionsCell);

                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("pending-load failed:", err);
                if (statusEl) statusEl.textContent = "Failed to load pending songs.";
            }
        }

        async function handleModerationAction(id, action) {
            const endpoint = action === "approve"
                ? `/api/admin/links/${id}/approve`
                : `/api/admin/links/${id}/reject`;
            const res = await fetch(endpoint, { method: "POST", headers: { "Content-Type": "application/json" } });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data?.ok === false) {
                throw new Error(data?.error || res.statusText || "request-failed");
            }
            if (typeof showFlash === "function") {
                showFlash(
                    action === "approve" ? "Song approved and published." : "Song declined.",
                    action === "approve" ? "success" : "error",
                    4000
                );
            }
            await loadPendingModeration();
            await loadLinksForCurrentSelection();
        }

        // REMOVE OLD ADMIN UI FUNCTIONS - DELETE updateAdminUI() and old btn-admin-set/clear handlers

        // NEW SESSION-BASED ADMIN FUNCTIONS
        async function adminLogin(token) {
            try {
                const r = await fetch("/api/admin/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token })
                });
                const data = await r.json();
                return r.ok;
            } catch (err) {
                console.error("Login error:", err);
                return false;
            }
        }

        async function adminVerify() {
            try {
                const r = await fetch("/api/admin/verify");
                const data = await r.json();
                return r.ok;
            } catch (err) {
                console.error("Verify error:", err);
                return false;
            }
        }

        async function adminLogout() {
            try {
                await fetch("/api/admin/logout", { method: "POST" });
            } catch (err) {
                console.error("Logout error:", err);
            }
        }

        async function refreshAdminState() {
            const isAdmin = await adminVerify();
            IS_ADMIN = isAdmin;
            const el = document.getElementById("admin-status");
            if (el) el.textContent = isAdmin ? "‚úÖ Admin session active" : "";

            document.getElementById("btn-admin-login").style.display = isAdmin ? "none" : "";
            document.getElementById("btn-admin-logout").style.display = isAdmin ? "" : "none";
            document.getElementById("btn-stats").style.display = isAdmin ? "" : "none";

            const moderationSection = document.getElementById("moderation-section");
            if (moderationSection) moderationSection.style.display = isAdmin ? "" : "none";

            if (isAdmin) {
                await loadPendingModeration();
            } else {
                clearPendingModeration();
            }
        }

        document.getElementById("btn-admin-login")?.addEventListener("click", async () => {
            const token = document.getElementById("admin-token-input").value.trim();
            if (!token) return;
            const ok = await adminLogin(token);
            if (!ok) {
                alert("Admin login failed");
            } else {
                alert("Login successful!");
                document.getElementById("admin-token-input").value = "";
                await refreshAdminState();
                await loadLinksForCurrentSelection();
            }
        });

        document.getElementById("btn-admin-logout")?.addEventListener("click", async () => {
            await adminLogout();
            await refreshAdminState();
            await loadLinksForCurrentSelection(); // Re-render without delete buttons
        });

        // stats button handler
        document.getElementById("btn-stats")?.addEventListener("click", async () => {
            try {
                const res = await fetch("/api/stats");
                if (!res.ok) {
                    const body = await res.json().catch(() => ({}));
                    alert("Failed to load stats: " + (body.error || res.status));
                    return;
                }
                const stats = await res.json();
                const message = `üìä Website Visit Statistics\n\n` +
                    `Total page visits: ${stats.total}\n` +
                    `Unique visitors (different IPs): ${stats.unique}\n` +
                    `Visits in last 24 hours: ${stats.today}`;
                alert(message);
            } catch (err) {
                alert("Failed to load stats: " + err.message);
                console.error(err);
            }
        });

        document.getElementById("btn-refresh-pending")?.addEventListener("click", async () => {
            await loadPendingModeration();
        });

        refreshAdminState();

        // Set info box contact line
        function initContactLinks() {
            document.querySelectorAll(".contact-email").forEach((btn) => {
                if (btn.dataset.bound === "1") return;
                btn.dataset.bound = "1";
                btn.addEventListener("click", () => {
                    const toChars = (value) =>
                        value
                            .split(",")
                            .map((code) => Number.parseInt(code.trim(), 10))
                            .filter((n) => Number.isFinite(n));
                    const localCodes = toChars(btn.dataset.emailLocal || "");
                    const domainCodes = toChars(btn.dataset.emailDomain || "");
                    const local = String.fromCharCode(...localCodes);
                    const domain = String.fromCharCode(...domainCodes);
                    window.location.href = `mailto:${local}@${domain}`;
                });
            });
        }

        const infoEl = document.getElementById("links-info");
        if (infoEl) {
            infoEl.innerHTML = 'Questions or feedback? <button type="button" class="contact-email" data-email-local="106,97,114,111,110,46,49,49,49" data-email-domain="104,111,116,109,97,105,108,46,99,111,109" style="background:none;border:none;color:#0066cc;text-decoration:underline;cursor:pointer;font:inherit;padding:0;">Email me</button>';
        }
        initContactLinks();

                // initial load
                loadParshiot();
                loadTanachBooks();
                // show new feature intro once per browser
                if (typeof openTanachIntroIfNeeded === "function") {
                    openTanachIntroIfNeeded();
                }
                

        // help modal control (KEEP ONLY THIS ONE)
        function openHelpModal() {
          const modal = document.getElementById("help-modal");
          modal.style.display = "flex";
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
          document.getElementById("help-modal-close").focus();
        }

        function closeHelpModal() {
          const modal = document.getElementById("help-modal");
          modal.style.display = "none";
          modal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
        }

        // help button click handler
        document.getElementById("help-btn").addEventListener("click", openHelpModal);

        // help modal close handlers
        document.getElementById("help-modal-close").addEventListener("click", closeHelpModal);

        // close on backdrop click or escape key
        document.addEventListener("click", (e) => {
          const helpModal = document.getElementById("help-modal");
          if (e.target === helpModal) closeHelpModal();
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeHelpModal();
            closeVerseModal();
          }
        });

                // One-time intro modal for Tanach linking
                function ensureTanachIntroModal() {
                        if (document.getElementById("tanach-intro-modal")) return;
                        const html = `
                        <div id="tanach-intro-modal" class="modal" aria-hidden="true" style="display:none">
                            <div class="modal-content" role="dialog" aria-modal="true" aria-label="New feature: Tanach linking">
                                <button id="tanach-intro-close" class="modal-close" aria-label="Close">√ó</button>
                                <h2 style="margin-top:0">New: Link songs to any Tanach chapter</h2>
                                <p>
                                    You can now connect songs not only to Parashiot or Haftarot, but also to any chapter across Tanach.
                                    Use the "Or pick any Tanach book" section to browse or add songs by book & chapter.
                                </p>
                                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
                                    <button id="tanach-intro-try" class="primary">Try it now</button>
                                    <button id="tanach-intro-gotit">Got it</button>
                                </div>
                            </div>
                        </div>`;
                        document.body.insertAdjacentHTML("beforeend", html);
                        const closeBtn = document.getElementById("tanach-intro-close");
                        const gotIt = document.getElementById("tanach-intro-gotit");
                        const tryBtn = document.getElementById("tanach-intro-try");
                        const modal = document.getElementById("tanach-intro-modal");
                        const closeFn = () => {
                            modal.style.display = "none";
                            modal.setAttribute("aria-hidden", "true");
                            document.body.style.overflow = "";
                            try { localStorage.setItem("tanachIntroSeen", "1"); } catch {}
                        };
                        closeBtn.addEventListener("click", closeFn);
                        gotIt.addEventListener("click", closeFn);
                        tryBtn.addEventListener("click", () => {
                            closeFn();
                            const el = document.getElementById("tanach-book-list");
                            if (el) {
                                el.scrollIntoView({ behavior: "smooth", block: "center" });
                                setTimeout(() => el.focus(), 350);
                            }
                        });
                }

                function openTanachIntro() {
                        ensureTanachIntroModal();
                        const modal = document.getElementById("tanach-intro-modal");
                        modal.style.display = "flex";
                        modal.setAttribute("aria-hidden", "false");
                        document.body.style.overflow = "hidden";
                        document.getElementById("tanach-intro-close").focus();
                }

                function openTanachIntroIfNeeded() {
                        try {
                                if (!localStorage.getItem("tanachIntroSeen")) {
                                        openTanachIntro();
                                }
                        } catch {
                                openTanachIntro();
                        }
                }

        document.getElementById("btn-save").addEventListener("click", async () => {
            const title = document.getElementById("song-title").value.trim();
            const link = document.getElementById("song-link").value.trim();
            const verse = document.getElementById("verse-ref").value.trim();

            if (!title) {
                alert("Need song name");
                return;
            }

            let external_url = null;
            if (link) {
                if (!/^https?:\/\//i.test(link)) {
                    alert("URL must start with http:// or https://");
                    return;
                }
                try { new URL(link); external_url = link; } catch {
                    alert("Invalid URL format.");
                    return;
                }
            }

            let payload;
            if (selectedKind === "tanach") {
                if (!selectedBookId || !selectedChapter) {
                    alert("Please select a book and chapter");
                    return;
                }
                payload = {
                    parasha_id: selectedBookId, // placeholder to satisfy backend
                    target_kind: "tanach",
                    book_id: selectedBookId,
                    chapter: selectedChapter,
                    song: { title, external_url },
                    verse_ref: verse || null,
                };
            } else {
                if (!selectedParashaId) {
                    alert("Need parasha selection");
                    return;
                }
                payload = {
                    parasha_id: selectedParashaId,
                    target_kind: selectedKind,
                    song: { title, external_url },
                    verse_ref: verse || null,
                    ...(selectedKind === "haftarah" ? { target_id: selectedHaftarahId } : {}),
                };
            }

            try {
                const res = await fetch("/api/links", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data?.error || res.statusText);

                await loadLinksForCurrentSelection();

                document.getElementById("song-title").value = "";
                document.getElementById("song-link").value = "";
                // always clear verse field after save; do not auto-fill
                document.getElementById("verse-ref").value = "";

                if (typeof showFlash === "function") {
                    const pending = data?.status === "pending";
                    showFlash(
                        pending
                            ? "Shkoyach for submitting! We'll review and publish it once approved."
                            : "Song added and published. Thank you!"
                    );
                } else {
                    console.log("Thank you for adding this song!");
                }
            } catch (err) {
                alert("Save failed: " + err.message);
            }
        });
    </script>
</body>

</html>