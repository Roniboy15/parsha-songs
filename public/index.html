<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Parsha â†” Songs</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <header class="site-header">
        <div class="site-title">
            <h1 class="main-title">Make Our Torah Sing</h1>
            <div id="total-songs" class="songs-count"></div>
        </div>

        <img src="logo.png" alt="Logo" class="site-logo" />
    </header>

    <section>
        <h2>Use today's parasha</h2>
        <button id="btn-current">Load current (diaspora)</button>
        <p id="current-parasha"></p>
    </section>

    <section>
        <h2>Or pick from list</h2>
        <select id="parsha-list"></select>

        <div style="margin-top: 1rem;">
            <label>
                <input type="radio" name="target-kind" value="parasha" checked />
                Link to parasha (Torah)
            </label>
            <label>
                <input type="radio" name="target-kind" value="haftarah" />
                Link to haftarah
            </label>
        </div>

        <div id="haftarah-wrap" style="display: none; margin-top: 0.5rem;">
            <label for="haftarah-list">Haftarah:</label>
            <select id="haftarah-list"></select>
        </div>
    </section>

    <section>
        <h2>Song details</h2>
        <input id="song-title" placeholder="Song name" />
        <input id="song-link" placeholder="Link (optional)" />
        <input id="verse-ref" placeholder="Verse number and chapter (optional)" />
        <button id="btn-save">Save</button>
    </section>

    <section>
        <h2>Songs for this selection</h2>
        <p id="links-info"></p>
        <table id="links-table" border="1" cellpadding="4">
            <thead>
                        <tr>
                            <th>Song</th>
                            <th>Link</th>
                            <th>Verse</th>
                            <th id="delete-header" style="display:none">Delete</th>
                        </tr>
                    </thead>
            <tbody id="links-tbody"></tbody>
        </table>
        <table>
            <!-- admin controls (local-only token) -->
            <div class="admin-controls" style="display:flex;align-items:center;gap:8px;margin-right:8px; margin-top: 30px;">
                <button id="btn-admin-set"">Set Admin Token</button>
                <button id="btn-admin-clear" style="display:none">Clear Admin</button>
                <button id="btn-stats" style="display:none">ğŸ“Š Visit Stats</button>
            </div>
        </table>
    </section>

    <!-- floating help button -->
    <button id="help-btn" class="help-button" aria-label="Help">?</button>

    <!-- help modal -->
    <div id="help-modal" class="modal" aria-hidden="true" style="display:none">
        <div class="modal-content help-modal-content" role="dialog" aria-modal="true" aria-label="About this app">
            <button id="help-modal-close" class="modal-close" aria-label="Close">Ã—</button>
            <div class="help-header">
                <h2>About Parsha Songs</h2>
                <div class="help-verse">
                    <div class="verse-hebrew">×•××ª× ×›×ª×‘×• ×œ×›× ××ª ×”×©×™×¨×” ×”×–××ª</div>
                    <div class="verse-english">"Now therefore write this song for yourselves"</div>
                    <div class="verse-source">Devarim 31:19</div>
                </div>
            </div>
            <div class="help-content">
                <p><strong>What is this?</strong></p>
                <p>This app helps you find songs that connect to weekly Torah portions (Parshiot) and their Haftarah readings.</p>
                
                <p><strong>How to use:</strong></p>
                <ol>
                    <li><strong>Select a Parsha:</strong> Choose from the dropdown (e.g., "Bereshit", "Noach")</li>
                    <li><strong>Pick Torah or Haftarah:</strong> Choose what you want songs for</li>
                    <li><strong>Browse existing songs:</strong> See what others have already shared</li>
                    <li><strong>Add your own:</strong> Share a song with lyrics from the weekly reading</li>
                </ol>

                <p><strong>Tips:</strong></p>
                <ul>
                    <li>Include YouTube, Spotify, or other music links when possible</li>
                    <li>Add verse references to show the connection (e.g. "1:22" for perek/chapter 1, pasuk/verse 22)</li>
                    <li>Help build a musical companion to Torah study!</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let ALL_PARSHIOT = [];
        let selectedParashaId = null;
        let selectedKind = "parasha";
        let selectedHaftarahId = null;

        // 1) load parshiot and build dropdown
        async function loadParshiot() {
            const res = await fetch("/api/parshiot");
            const parshiot = await res.json();
            ALL_PARSHIOT = parshiot;

            const byBook = {};
            parshiot.forEach((p) => {
                if (!byBook[p.book]) byBook[p.book] = [];
                byBook[p.book].push(p);
            });

            const order = ["bereshit", "shemot", "vayikra", "bamidbar", "devarim"];
            const select = document.getElementById("parsha-list");
            select.innerHTML = "";

            order.forEach((book) => {
                const list = byBook[book];
                if (!list) return;
                const og = document.createElement("optgroup");
                og.label = list[0].book_en;
                list.sort((a, b) => a.order_index - b.order_index);
                list.forEach((p) => {
                    const opt = document.createElement("option");
                    opt.value = p.id;
                    opt.textContent = p.name_en;
                    og.appendChild(opt);
                });
                select.appendChild(og);
            });

            // default selection
            if (parshiot.length) {
                selectedParashaId = parshiot[0].id;
                populateHaftarot(selectedParashaId);
                await loadLinksForCurrentSelection(); // show initial links
            }

            // when user changes parasha
            select.addEventListener("change", async (e) => {
                selectedParashaId = e.target.value;
                populateHaftarot(selectedParashaId);
                await loadLinksForCurrentSelection();
            });
        }

        // 2) fill haftarot for a given parasha
        function populateHaftarot(parashaId) {
            const wrap = document.getElementById("haftarah-wrap");
            const sel = document.getElementById("haftarah-list");
            sel.innerHTML = "";

            const parasha = ALL_PARSHIOT.find((p) => p.id === parashaId);
            if (!parasha) return;

            const list =
                parasha.haftarot?.diaspora && parasha.haftarot.diaspora.length
                    ? parasha.haftarot.diaspora
                    : [];

            list.forEach((h) => {
                const opt = document.createElement("option");
                opt.value = h.id;
                opt.textContent = h.name;
                sel.appendChild(opt);
            });

            selectedHaftarahId = list.length ? list[0].id : null;
            wrap.style.display =
                selectedKind === "haftarah" && list.length ? "block" : "none";
        }

        // 3) load current parasha from backend/he bcal
        document.getElementById("btn-current").addEventListener("click", async () => {
            const res = await fetch("/api/current-reading");
            const data = await res.json();
            const p = document.getElementById("current-parasha");

            if (!data.ok) {
                p.textContent = "No parasha in the next 7 days.";
                return;
            }

            const currentId = data.parasha.id;
            const currentName = data.parasha.name_en;

            // show it on top
            p.textContent = `Today / next Shabbat: ${currentName} (${currentId})`;

            // update state
            selectedParashaId = currentId;

            // update dropdown if option exists
            const select = document.getElementById("parsha-list");
            const option = Array.from(select.options).find(
                (opt) => opt.value === currentId
            );
            if (option) {
                select.value = currentId;
            }

            // update haftarot & table
            populateHaftarot(selectedParashaId);
            await loadLinksForCurrentSelection();
        });



        // 4) radio buttons (parasha / haftarah)
        document
            .querySelectorAll('input[name="target-kind"]')
            .forEach((input) => {
                input.addEventListener("change", async (e) => {
                    selectedKind = e.target.value;
                    populateHaftarot(selectedParashaId);
                    await loadLinksForCurrentSelection();
                });
            });

        // 5) save new link
        document.getElementById("btn-save").addEventListener("click", async () => {
            const title = document.getElementById("song-title").value.trim();
            const link = document.getElementById("song-link").value.trim();
            const verse = document.getElementById("verse-ref").value.trim();

            // Validate inputs
            if (!title || !selectedParashaId) {
                alert("Need song name + parasha");
                return;
            }

            if (verse.length > 60) {
                alert("Too much text, please just add the Chapter and Verse number");
                return;
            }

            // URL validation
            let external_url = null;
            if (link) {
                if (!link.startsWith('http://') && !link.startsWith('https://')) {
                    alert("URL must start with http:// or https://");
                    return;
                }
                try {
                    new URL(link);
                    external_url = link;
                } catch (e) {
                    alert("Invalid URL format. Please enter a complete URL (e.g., https://youtube.com/watch?v=...)");
                    return;
                }
            }

            const payload = {
                parasha_id: selectedParashaId,
                target_kind: selectedKind,
                song: { 
                    title,
                    external_url 
                },
                verse_ref: verse || null
            };

            if (selectedKind === "haftarah") {
                payload.target_id = selectedHaftarahId;
            }

            // Build headers: always include contrib token, and admin token if present
            const headers = {
                "Content-Type": "application/json",
                "x-contrib-token": window.CONTRIB_TOKEN || ""
            };
            
            const adminToken = localStorage.getItem("adminToken");
            if (adminToken) {
                headers["x-admin-token"] = adminToken;
            }

            try {
                const res = await fetch("/api/links", {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(`Error (${res.status}): ${JSON.stringify(data)}`);
                }

                await loadLinksForCurrentSelection();
                
                // Clear inputs after successful save
                document.getElementById("song-title").value = "";
                document.getElementById("song-link").value = "";
                document.getElementById("verse-ref").value = "";
            } catch (err) {
                alert("Save failed: " + err.message);
            }
        });

        // 6) load links for current parasha/kind
        async function loadLinksForCurrentSelection() {
            if (!selectedParashaId) return;

            // Get total songs count first
            const totalRes = await fetch("/api/total-songs");
            const totalData = await totalRes.json();

            // Then get current parasha songs
            const params = new URLSearchParams({ parasha_id: selectedParashaId });
            params.set("target_kind", selectedKind);
            const res = await fetch(`/api/links?${params.toString()}`);
            const rows = await res.json();

            // Update both counts
            const totalSongs = document.getElementById("total-songs");
            // totalSongs.textContent = `Total songs: ${totalData.total} (${rows.length} in current selection)`;
            totalSongs.textContent = `${totalData.total} songs connected so far`;

            // Clear existing table content
            const tbody = document.querySelector("#links-table tbody");
            tbody.innerHTML = "";

            rows.forEach((row) => {
                const tr = document.createElement("tr");

                const tdSong = document.createElement("td");
                tdSong.textContent = row.song_title;
                tdSong.className = "col-song";
                tdSong.title = row.song_title; // show full title on hover
                tr.appendChild(tdSong);

                const tdUrl = document.createElement("td");
                if (row.song_url) {
                    // Always create a link element if we have a URL
                    const a = document.createElement("a");
                    a.href = row.song_url;
                    // Show a shorter version of the URL
                    let displayUrl = row.song_url;
                    if (displayUrl.length > 40) {
                        displayUrl = displayUrl.substring(0, 37) + "...";
                    }
                    a.textContent = displayUrl;
                    a.target = "_blank";
                    a.rel = "noopener";
                    a.style.color = "#0066cc";
                    a.style.textDecoration = "underline";
                    tdUrl.appendChild(a);
                    // Add full URL as tooltip
                    tdUrl.title = row.song_url;
                } else {
                    tdUrl.textContent = "-";
                    tdUrl.style.color = "#999";
                }
                tr.appendChild(tdUrl);

                const tdVerse = document.createElement("td");
                // show truncated verse in the table and open a modal on click for longer text
                const fullVerse = row.verse_ref || "";
                const tdVerseTextMax = 30; // how many chars to show in table before truncating
                if (fullVerse) {
                    if (fullVerse.length > tdVerseTextMax) {
                        const short = fullVerse.slice(0, tdVerseTextMax - 3) + "...";
                        tdVerse.textContent = short;
                        tdVerse.title = "Click to read full text";
                        tdVerse.className = "col-verse clickable-verse";
                        tdVerse.addEventListener("click", () => openVerseModal(fullVerse));
                    } else {
                        tdVerse.textContent = fullVerse;
                        tdVerse.title = fullVerse;
                        tdVerse.className = "col-verse";
                    }
                } else {
                    tdVerse.textContent = "";
                    tdVerse.className = "col-verse";
                }
                tr.appendChild(tdVerse);

                // const tdTarget = document.createElement("td");
                // tdTarget.textContent = row.target_kind;
                // tr.appendChild(tdTarget);

                // Delete column (only create if admin is logged in)
                const adminToken = localStorage.getItem("adminToken");
                if (adminToken) {
                    const tdDel = document.createElement("td");
                    const btn = document.createElement("button");
                    btn.textContent = "ğŸ—‘";
                    btn.addEventListener("click", async () => {
                        if (!confirm("Delete this link?")) return;
                        const tokenToSend = localStorage.getItem("adminToken") || "";
                        const res = await fetch(`/api/links/${row.id}`, {
                            method: "DELETE",
                            headers: { "x-admin-token": tokenToSend },
                        });
                        if (!res.ok) {
                            const d = await res.json().catch(() => ({}));
                            alert("Delete failed: " + (d.error || res.status));
                            return;
                        }
                        await loadLinksForCurrentSelection();
                    });
                    tdDel.appendChild(btn);
                    tr.appendChild(tdDel);
                }

                tbody.appendChild(tr);
            });
        }



        // modal markup (inserted once; functions below will use these elements)
        // place this markup at the end of the existing <script> or right before </body>
        const modalHtml = `
        <div id="verse-modal" class="modal" aria-hidden="true" style="display:none">
          <div class="modal-content" role="dialog" aria-modal="true" aria-label="Full verse text">
            <button id="verse-modal-close" class="modal-close" aria-label="Close">Ã—</button>
            <pre id="verse-modal-text"></pre>
          </div>
        </div>
        `;
        // append modal to body if not present
        if (!document.getElementById("verse-modal")) {
            document.body.insertAdjacentHTML("beforeend", modalHtml);
        }

        // modal control functions
        function openVerseModal(text) {
            const modal = document.getElementById("verse-modal");
            const pre = document.getElementById("verse-modal-text");
            pre.textContent = text;
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
            document.getElementById("verse-modal-close").focus();
        }
        function closeVerseModal() {
            const modal = document.getElementById("verse-modal");
            modal.style.display = "none";
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        }
        // close handlers
        document.addEventListener("click", (e) => {
            const modal = document.getElementById("verse-modal");
            if (!modal) return;
            if (e.target && e.target.id === "verse-modal-close") closeVerseModal();
            if (e.target === modal) closeVerseModal();
        });
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeVerseModal();
        });

        // admin token UI (keeps token only in browser localStorage)
        function updateAdminUI() {
            const token = localStorage.getItem("adminToken");
            document.getElementById("btn-admin-set").style.display = token ? "none" : "";
            document.getElementById("btn-admin-clear").style.display = token ? "" : "none";
            document.getElementById("btn-stats").style.display = token ? "" : "none";
            
            // show/hide delete column header
            const deleteHeader = document.getElementById("delete-header");
            deleteHeader.style.display = token ? "" : "none";
        }

        document.getElementById("btn-admin-set").addEventListener("click", async () => {
            const v = prompt("Paste admin token (kept locally only)");
            if (!v) return;
            const candidate = v.trim();
            try {
                const res = await fetch(`/api/admin/verify`, {
                    method: "GET",
                    headers: { "x-admin-token": candidate },
                });
                if (!res.ok) {
                    const body = await res.json().catch(()=>({}));
                    alert("Invalid admin token: " + (body.error || res.status));
                    return;
                }
                localStorage.setItem("adminToken", candidate);
                updateAdminUI();
                await loadLinksForCurrentSelection(); // re-render table to show delete buttons
                alert("Admin token accepted. Delete buttons are now visible.");
            } catch (err) {
                alert("Verification failed. Check server and try again.");
                console.error(err);
            }
        });

        document.getElementById("btn-admin-clear").addEventListener("click", async () => {
            localStorage.removeItem("adminToken");
            updateAdminUI();
            await loadLinksForCurrentSelection(); // re-render table to hide delete buttons
        });

        // stats button handler
        document.getElementById("btn-stats").addEventListener("click", async () => {
            const token = localStorage.getItem("adminToken");
            if (!token) {
                alert("Admin token required");
                return;
            }
            
            try {
                const res = await fetch("/api/stats", {
                    headers: { "x-admin-token": token }
                });
                
                if (!res.ok) {
                    const body = await res.json().catch(() => ({}));
                    alert("Failed to load stats: " + (body.error || res.status));
                    return;
                }
                
                const stats = await res.json();
                const message = `ğŸ“Š Website Visit Statistics\n\n` +
                    `Total page visits: ${stats.total}\n` +
                    `Unique visitors (different IPs): ${stats.unique}\n` +
                    `Visits in last 24 hours: ${stats.today}`;
                    
                alert(message);
            } catch (err) {
                alert("Failed to load stats: " + err.message);
                console.error(err);
            }
        });

        updateAdminUI();

        // initial load
        loadParshiot();

        // help modal control
        function openHelpModal() {
            const modal = document.getElementById("help-modal");
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
            document.getElementById("help-modal-close").focus();
        }

        function closeHelpModal() {
            const modal = document.getElementById("help-modal");
            modal.style.display = "none";
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        }

        // help button click handler
        document.getElementById("help-btn").addEventListener("click", openHelpModal);

        // help modal close handlers
        document.getElementById("help-modal-close").addEventListener("click", closeHelpModal);

        // close on backdrop click or escape key (reuse existing modal handlers)
        document.addEventListener("click", (e) => {
            const helpModal = document.getElementById("help-modal");
            if (e.target === helpModal) closeHelpModal();
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                closeHelpModal();
                closeVerseModal(); // existing verse modal handler
            }
        });
    </script>
</body>
</html>