<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Parsha-Songs</title>

    <!-- Favicon / tab & device icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="logo-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo-16.png">
    <!-- Optional: classic .ico (can include multiple sizes) -->
    <link rel="shortcut icon" href="favicon.ico">
    <!-- Optional: Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <!-- Optional: high-res for Android -->
    <link rel="manifest" href="site.webmanifest">
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .loading-dots {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        .loading-dots span {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #444;
            display: block;
            animation: ldots 1s infinite ease-in-out;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: .2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: .4s;
        }

        @keyframes ldots {

            0%,
            80%,
            100% {
                opacity: .2;
                transform: scale(.7);
            }

            40% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>

    <!-- Open Graph meta tags for link previews -->
    <meta property="og:title" content="Make the Parasha Sing" />
    <meta property="og:description"
        content="Find and share songs that connect to weekly Torah portions (Parshiot) and Haftarah readings" />
    <meta property="og:url" content="https://parsha-songs.onrender.com" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Parsha Songs" />
    <meta property="og:image" content="https://parsha-songs.onrender.com/og-image.png?v=1" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Parsha Songs ‚Äì Make the Parasha Sing" />




    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Make the Parasha Sing" />
    <meta name="twitter:description"
        content="Find and share songs that connect to weekly Torah portions (Parshiot) and Haftarah readings" />
    <meta name="twitter:image" content="https://parsha-songs.onrender.com/logo.png" />

    <!-- General meta tags -->
    <meta name="description"
        content="Find and share songs that connect to weekly Torah portions (Parshiot) and Haftarah readings" />
    <link rel="canonical" href="https://parsha-songs.onrender.com/">
    <!-- optional -->
    <meta name="keywords" content="Torah, Parsha, Haftarah, Songs, Jewish music">
</head>

<body>
    <header class="site-header">
        <div class="site-title">
            <h1 class="main-title">Make the Parasha Sing</h1>
            <div id="total-songs" class="songs-count"></div>
        </div>

        <img src="logo.png" alt="Logo" class="site-logo" />
    </header>

    <section>
        <h2>Use this week's parasha</h2>
        <button id="btn-current">Load parasha</button>
        <p id="current-parasha"></p>
    </section>

    <section>
        <h2>Or pick from list</h2>
        <select id="parsha-list"></select>

        <div style="margin-top: 1rem;">
            <label>
                <input type="radio" name="target-kind" value="parasha" checked />
                Link to parasha
            </label>
            <label>
                <input type="radio" name="target-kind" value="haftarah" />
                Link to haftarah
            </label>
        </div>

        <div id="haftarah-wrap" style="display: none; margin-top: 0.5rem;">
            <label for="haftarah-list">Haftarah:</label>
            <select id="haftarah-list"></select>
        </div>
    </section>

    <section>
        <h2 id="connect-song-title">Connect a new song</h2>
        <input id="song-title" placeholder="Song name" />
        <input id="song-link" placeholder="Link (optional)" />
        <input id="verse-ref" placeholder="Verse number and chapter (optional)" />
        <button id="btn-save">Save</button>

        <!-- Flash message (success) -->
        <div id="flash" role="status" aria-live="polite"
            style="display:none;margin-top:8px;padding:8px 12px;background:#e6ffed;border:1px solid #2ea44f;color:#1b6e3b;border-radius:6px;">
        </div>
    </section>

    <section>
        <h2 id="songs-section-title">Songs for this selection</h2>
        <table id="links-table" cellpadding="4">
            <thead>
                <tr>
                    <th>Song</th>
                    <th>Link</th>
                    <th>Verse</th>
                    <th id="delete-header" style="display:none">Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="links-info"></p>
        <div id="links-loading" class="loading-dots" aria-live="polite" style="display:none">
            <span></span><span></span><span></span>
        </div>
    </section>

    <section>
        <h3>Admin</h3>
        <p id="admin-status"></p>
        <input id="admin-token-input" type="password" placeholder="Admin token" />
        <button id="btn-admin-login">Login</button>
        <button id="btn-admin-logout" style="display:none">Logout</button>
        <button id="btn-stats" style="display:none">üìä Visit Stats</button>
    </section>

    <!-- floating help button -->
    <button id="help-btn" class="help-button" aria-label="Help">?</button>

    <!-- help modal -->
    <div id="help-modal" class="modal" aria-hidden="true" style="display:none">
        <div class="modal-content help-modal-content" role="dialog" aria-modal="true" aria-label="About this app">
            <button id="help-modal-close" class="modal-close" aria-label="Close">√ó</button>
            <div class="help-header">
                <h2>About Parsha Songs</h2>
                <div class="help-verse">
                    <div class="verse-hebrew">◊ï◊ê◊™◊ù ◊õ◊™◊ë◊ï ◊ú◊õ◊ù ◊ê◊™ ◊î◊©◊ô◊®◊î ◊î◊ñ◊ê◊™</div>
                    <div class="verse-english">"Now therefore write this song for yourselves"</div>
                    <div class="verse-source">Devarim 31:19</div>
                </div>
            </div>
            <div class="help-content">
                <p><strong>What is this?</strong></p>
                <p>This app helps you find songs that connect to weekly Torah portions (Parshiot) and their Haftarah
                    readings.</p>

                <p><strong>How to use:</strong></p>
                <ol>
                    <li><strong>Select a Parsha:</strong> Choose from the dropdown (e.g., "Bereshit", "Noach")</li>
                    <li><strong>Pick Torah or Haftarah:</strong> Choose what you want songs for</li>
                    <li><strong>Browse existing songs:</strong> See what others have already shared</li>
                    <li><strong>Add your own:</strong> Share a song with lyrics from the weekly reading</li>
                </ol>

                <p><strong>Tips:</strong></p>
                <ul>
                    <li>Include YouTube, Spotify, or other music links when possible</li>
                    <li>Add verse references to show the connection (e.g. "1:22")</li>
                    <li>Help build a musical companion to Torah study!</li>
                </ul>
                <p><strong>Contact:</strong>
                    <a href="mailto:jaron.111@hotmail.com">jaron.111@hotmail.com</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        let ALL_PARSHIOT = [];
        let selectedParashaId = null;
        let selectedKind = "parasha";
        let selectedHaftarahId = null;
        let selectedDisplayName = "";
        let currentLinksAbort = null;
        function beginLinksLoad() {
            const tbody = document.querySelector("#links-table tbody");
            if (tbody) tbody.innerHTML = "";
            const info = document.getElementById("links-info");
            if (info) info.textContent = "";
            const loader = document.getElementById("links-loading");
            if (loader) loader.style.display = "inline-flex";
        }

        // 1) load parshiot and build dropdown
        async function loadParshiot() {
            const res = await fetch("/api/parshiot");
            const parshiot = await res.json();
            ALL_PARSHIOT = parshiot;

            const byBook = {};
            parshiot.forEach((p) => {
                if (!byBook[p.book]) byBook[p.book] = [];
                byBook[p.book].push(p);
            });

            const order = ["bereshit", "shemot", "vayikra", "bamidbar", "devarim"];
            const select = document.getElementById("parsha-list");
            select.innerHTML = "";

            order.forEach((book) => {
                const list = byBook[book];
                if (!list) return;
                const og = document.createElement("optgroup");
                og.label = list[0].book_en;
                list.sort((a, b) => a.order_index - b.order_index);
                list.forEach((p) => {
                    const opt = document.createElement("option");
                    opt.value = p.id;
                    opt.textContent = p.name_en;
                    og.appendChild(opt);
                });
                select.appendChild(og);
            });

            // default selection
            if (parshiot.length) {
                selectedParashaId = parshiot[0].id;
                updateSelectedDisplayName(); // Add this call
                populateHaftarot(selectedParashaId);
                await loadLinksForCurrentSelection(); // show initial links
            }

            // when user changes parasha
            select.addEventListener("change", async (e) => {
                selectedParashaId = e.target.value;
                beginLinksLoad();
                updateSelectedDisplayName(); // Add this call
                populateHaftarot(selectedParashaId);
                await loadLinksForCurrentSelection();
            });
        }

        // Add this new function
        function updateSelectedDisplayName() {
            const parasha = ALL_PARSHIOT.find((p) => p.id === selectedParashaId);
            if (!parasha) {
                selectedDisplayName = "this selection";
                updateSectionTitle();
                return;
            }

            if (selectedKind === "parasha") {
                selectedDisplayName = `Parashat ${parasha.name_en}`;
            } else if (selectedKind === "haftarah") {
                const haftarah = parasha.haftarot?.diaspora?.find(h => h.id === selectedHaftarahId);
                if (haftarah) {
                    selectedDisplayName = `${haftarah.name} (Haftarah for ${parasha.name_en})`;
                } else {
                    selectedDisplayName = `Haftarah for ${parasha.name_en}`;
                }
            }
            updateSectionTitle();
        }

        // Add this new function
        function updateSectionTitle() {
            const title = document.getElementById("songs-section-title");
            title.textContent = `Songs for ${selectedDisplayName}`;

            // Update the connect song title too
            const connectTitle = document.getElementById("connect-song-title");
            connectTitle.textContent = `Connect a new song to ${selectedDisplayName}`;
        }

        // 2) fill haftarot for a given parasha
        function populateHaftarot(parashaId) {
            const wrap = document.getElementById("haftarah-wrap");
            const sel = document.getElementById("haftarah-list");
            sel.innerHTML = "";

            const parasha = ALL_PARSHIOT.find((p) => p.id === parashaId);
            if (!parasha) return;

            const list =
                parasha.haftarot?.diaspora && parasha.haftarot.diaspora.length
                    ? parasha.haftarot.diaspora
                    : [];

            list.forEach((h) => {
                const opt = document.createElement("option");
                opt.value = h.id;
                opt.textContent = h.name;
                sel.appendChild(opt);
            });

            selectedHaftarahId = list.length ? list[0].id : null;
            updateSelectedDisplayName(); // Add this call
            wrap.style.display =
                selectedKind === "haftarah" && list.length ? "block" : "none";

            // Add haftarah selection change listener
            sel.onchange = async (e) => {
                selectedHaftarahId = e.target.value;
                beginLinksLoad();
                updateSelectedDisplayName();
                await loadLinksForCurrentSelection();
            };
        }

        // 3) load current parasha from backend/he bcal
        document.getElementById("btn-current").addEventListener("click", async () => {
            beginLinksLoad();
            const res = await fetch("/api/current-reading");
            const data = await res.json();
            const p = document.getElementById("current-parasha");

            if (!data.ok) {
                p.textContent = "No parasha in the next 7 days.";
                return;
            }

            const currentId = data.parasha.id;
            const currentName = data.parasha.name_en;

            // show it on top
            p.textContent = `This Shabbat: ${currentName}`;

            // update state
            selectedParashaId = currentId;

            // update dropdown if option exists
            const select = document.getElementById("parsha-list");
            const option = Array.from(select.options).find(
                (opt) => opt.value === currentId
            );
            if (option) {
                select.value = currentId;
            }

            // update haftarot & table
            updateSelectedDisplayName(); // Add this call
            populateHaftarot(selectedParashaId);
            await loadLinksForCurrentSelection();
        });

        // 4) radio buttons (parasha / haftarah)
        document
            .querySelectorAll('input[name="target-kind"]')
            .forEach((input) => {
                input.addEventListener("change", async (e) => {
                    selectedKind = e.target.value;
                    beginLinksLoad();
                    updateSelectedDisplayName(); // Add this call
                    populateHaftarot(selectedParashaId);
                    await loadLinksForCurrentSelection();
                });
            });

        // // 5) save new link
        // document.getElementById("btn-save").addEventListener("click", async () => {
        //     const title = document.getElementById("song-title").value.trim();
        //     const link = document.getElementById("song-link").value.trim();
        //     const verse = document.getElementById("verse-ref").value.trim();

        //     // Validate inputs
        //     if (!title || !selectedParashaId) {
        //         alert("Need song name + parasha");
        //         return;
        //     }

        //     if (verse.length > 60) {
        //         alert("Too much text, please just add the Chapter and Verse number");
        //         return;
        //     }

        //     // URL validation
        //     let external_url = null;
        //     if (link) {
        //         if (!link.startsWith('http://') && !link.startsWith('https://')) {
        //             alert("URL must start with http:// or https://");
        //             return;
        //         }
        //         try {
        //             new URL(link);
        //             external_url = link;
        //         } catch (e) {
        //             alert("Invalid URL format. Please enter a complete URL (e.g., https://youtube.com/watch?v=...)");
        //             return;
        //         }
        //     }

        //     const payload = {
        //         parasha_id: selectedParashaId,
        //         target_kind: selectedKind,
        //         song: {
        //             title,
        //             external_url
        //         },
        //         verse_ref: verse || null
        //     };

        //     if (selectedKind === "haftarah") {
        //         payload.target_id = selectedHaftarahId;
        //     }

        //     // REMOVE OLD TOKEN LOGIC - sessions handle auth automatically via cookies
        //     try {
        //         const res = await fetch("/api/links", {
        //             method: "POST",
        //             headers: {
        //                 "Content-Type": "application/json"
        //             },
        //             body: JSON.stringify(payload)
        //         });

        //         const data = await res.json();

        //         if (!res.ok) {
        //             throw new Error(`Error (${res.status}): ${JSON.stringify(data)}`);
        //         }

        //         await loadLinksForCurrentSelection();

        //         // Clear inputs after successful save
        //         document.getElementById("song-title").value = "";
        //         document.getElementById("song-link").value = "";
        //         document.getElementById("verse-ref").value = "";

        //         // Show success message
        //         const flash = document.getElementById("flash");
        //         flash.textContent = "Song saved successfully!";
        //         flash.style.display = "block";
        //         setTimeout(() => {
        //             flash.style.display = "none";
        //         }, 3000);
        //     } catch (err) {
        //         alert("Save failed: " + err.message);
        //     }
        // });

        // 6) load links for current parasha/kind
        async function loadLinksForCurrentSelection() {
            if (!selectedParashaId) return;
            if (currentLinksAbort) currentLinksAbort.abort();
            currentLinksAbort = new AbortController();
            const { signal } = currentLinksAbort;
            beginLinksLoad();

            let rows = [];
            let totalData = { total: 0 };
            try {
                const totalRes = await fetch("/api/total-songs", { signal });
                totalData = await totalRes.json();
                const params = new URLSearchParams({ parasha_id: selectedParashaId });
                params.set("target_kind", selectedKind);
                const res = await fetch(`/api/links?${params.toString()}`, { signal });
                rows = await res.json();
            } catch (err) {
                const loader = document.getElementById("links-loading");
                if (loader) loader.style.display = "none";
                if (err.name === "AbortError") return;
                console.error("Load failed:", err);
                const info = document.getElementById("links-info");
                if (info) info.textContent = "Fehler beim Laden.";
                return;
            } finally {
                currentLinksAbort = null;
            }

            const totalSongs = document.getElementById("total-songs");
            totalSongs.textContent = `${totalData.total} songs connected so far`;
            const tbody = document.querySelector("#links-table tbody");
            if (!tbody) {
                const loader = document.getElementById("links-loading");
                if (loader) loader.style.display = "none";
                return;
            }
            tbody.innerHTML = "";

            const isAdmin = await adminVerify();

            rows.forEach((row) => {
                const tr = document.createElement("tr");

                const tdSong = document.createElement("td");
                tdSong.textContent = row.song_title;
                tdSong.className = "col-song";
                tdSong.title = row.song_title;
                tr.appendChild(tdSong);

                const tdUrl = document.createElement("td");
                if (row.song_url) {
                    const a = document.createElement("a");
                    a.href = row.song_url;
                    let displayUrl = row.song_url;
                    if (displayUrl.length > 40) {
                        displayUrl = displayUrl.substring(0, 37) + "...";
                    }
                    a.textContent = displayUrl;
                    a.target = "_blank";
                    a.rel = "noopener";
                    a.style.color = "#0066cc";
                    a.style.textDecoration = "underline";
                    tdUrl.appendChild(a);
                    tdUrl.title = row.song_url;
                } else {
                    tdUrl.textContent = "-";
                    tdUrl.style.color = "#999";
                }
                tr.appendChild(tdUrl);

                const tdVerse = document.createElement("td");
                const fullVerse = row.verse_ref || "";
                const tdVerseTextMax = 30;
                if (fullVerse) {
                    if (fullVerse.length > tdVerseTextMax) {
                        const short = fullVerse.slice(0, tdVerseTextMax - 3) + "...";
                        tdVerse.textContent = short;
                        tdVerse.title = "Click to read full text";
                        tdVerse.className = "col-verse clickable-verse";
                        tdVerse.addEventListener("click", () => openVerseModal(fullVerse));
                    } else {
                        tdVerse.textContent = fullVerse;
                        tdVerse.title = fullVerse;
                        tdVerse.className = "col-verse";
                    }
                } else {
                    tdVerse.textContent = "";
                    tdVerse.className = "col-verse";
                }
                tr.appendChild(tdVerse);

                // Delete column (only if admin)
                if (isAdmin) {
                    const tdDel = document.createElement("td");
                    const btn = document.createElement("button");
                    btn.textContent = "üóë";
                    btn.addEventListener("click", async () => {
                        if (!confirm("Delete this link?")) return;
                        const res = await fetch(`/api/links/${row.id}`, {
                            method: "DELETE",
                        });
                        if (!res.ok) {
                            const d = await res.json().catch(() => ({}));
                            alert("Delete failed: " + (d.error || res.status));
                            return;
                        }
                        await loadLinksForCurrentSelection();
                    });
                    tdDel.appendChild(btn);
                    tr.appendChild(tdDel);
                }

                tbody.appendChild(tr);
            });

            // Update delete header visibility
            const deleteHeader = document.getElementById("delete-header");
            if (deleteHeader) deleteHeader.style.display = isAdmin ? "" : "none";

            const loader = document.getElementById("links-loading");
            if (loader) loader.style.display = "none";
            const info = document.getElementById("links-info");
            if (info && rows.length === 0) info.textContent = "No songs found.";
        }



        // modal markup (inserted once; functions below will use these elements)
        // place this markup at the end of the existing <script> or right before </body>
        const modalHtml = `
        <div id="verse-modal" class="modal" aria-hidden="true" style="display:none">
          <div class="modal-content" role="dialog" aria-modal="true" aria-label="Full verse text">
            <button id="verse-modal-close" class="modal-close" aria-label="Close">√ó</button>
            <pre id="verse-modal-text"></pre>
          </div>
        </div>
        `;
        // append modal to body if not present
        if (!document.getElementById("verse-modal")) {
            document.body.insertAdjacentHTML("beforeend", modalHtml);
        }

        // modal control functions
        function openVerseModal(text) {
            const modal = document.getElementById("verse-modal");
            const pre = document.getElementById("verse-modal-text");
            pre.textContent = text;
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
            document.getElementById("verse-modal-close").focus();
        }
        function closeVerseModal() {
            const modal = document.getElementById("verse-modal");
            modal.style.display = "none";
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        }
        // close handlers
        document.addEventListener("click", (e) => {
            const modal = document.getElementById("verse-modal");
            if (!modal) return;
            if (e.target && e.target.id === "verse-modal-close") closeVerseModal();
            if (e.target === modal) closeVerseModal();
        });
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeVerseModal();
        });

        // REMOVE OLD ADMIN UI FUNCTIONS - DELETE updateAdminUI() and old btn-admin-set/clear handlers

        // NEW SESSION-BASED ADMIN FUNCTIONS
        async function adminLogin(token) {
            try {
                const r = await fetch("/api/admin/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token })
                });
                const data = await r.json();
                return r.ok;
            } catch (err) {
                console.error("Login error:", err);
                return false;
            }
        }

        async function adminVerify() {
            try {
                const r = await fetch("/api/admin/verify");
                const data = await r.json();
                return r.ok;
            } catch (err) {
                console.error("Verify error:", err);
                return false;
            }
        }

        async function adminLogout() {
            try {
                await fetch("/api/admin/logout", { method: "POST" });
            } catch (err) {
                console.error("Logout error:", err);
            }
        }

        async function refreshAdminState() {
            const isAdmin = await adminVerify();
            const el = document.getElementById("admin-status");
            if (el) el.textContent = isAdmin ? "‚úÖ Admin session active" : "";

            document.getElementById("btn-admin-login").style.display = isAdmin ? "none" : "";
            document.getElementById("btn-admin-logout").style.display = isAdmin ? "" : "none";
            document.getElementById("btn-stats").style.display = isAdmin ? "" : "none";
        }

        document.getElementById("btn-admin-login")?.addEventListener("click", async () => {
            const token = document.getElementById("admin-token-input").value.trim();
            if (!token) return;
            const ok = await adminLogin(token);
            if (!ok) {
                alert("Admin login failed");
            } else {
                alert("Login successful!");
                document.getElementById("admin-token-input").value = "";
                await refreshAdminState();
                await loadLinksForCurrentSelection();
            }
        });

        document.getElementById("btn-admin-logout")?.addEventListener("click", async () => {
            await adminLogout();
            await refreshAdminState();
            await loadLinksForCurrentSelection(); // Re-render without delete buttons
        });

        // stats button handler
        document.getElementById("btn-stats")?.addEventListener("click", async () => {
            try {
                const res = await fetch("/api/stats");
                if (!res.ok) {
                    const body = await res.json().catch(() => ({}));
                    alert("Failed to load stats: " + (body.error || res.status));
                    return;
                }
                const stats = await res.json();
                const message = `üìä Website Visit Statistics\n\n` +
                    `Total page visits: ${stats.total}\n` +
                    `Unique visitors (different IPs): ${stats.unique}\n` +
                    `Visits in last 24 hours: ${stats.today}`;
                alert(message);
            } catch (err) {
                alert("Failed to load stats: " + err.message);
                console.error(err);
            }
        });

        refreshAdminState();

        // Set info box contact line
        const infoEl = document.getElementById("links-info");
        if (infoEl) {
            infoEl.innerHTML = 'Questions or feedback? Contact <a href="mailto:jaron.111@hotmail.com">jaron.111@hotmail.com</a>';
        }

        // initial load
        loadParshiot();

        // help modal control
        function openHelpModal() {
            const modal = document.getElementById("help-modal");
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
            document.getElementById("help-modal-close").focus();
        }

        function closeHelpModal() {
            const modal = document.getElementById("help-modal");
            modal.style.display = "none";
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        }

        // help button click handler
        document.getElementById("help-btn").addEventListener("click", openHelpModal);

        // help modal close handlers
        document.getElementById("help-modal-close").addEventListener("click", closeHelpModal);

        // close on backdrop click or escape key (reuse existing modal handlers)
        document.addEventListener("click", (e) => {
            const helpModal = document.getElementById("help-modal");
            if (e.target === helpModal) closeHelpModal();
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                closeHelpModal();
                closeVerseModal(); // existing verse modal handler
            }
        });

        // keep only one of these helpers
        let flashTimer = null;
        function showFlash(msg) {
            const el = document.getElementById("flash");
            if (!el) return;
            el.textContent = msg;
            el.style.display = "block";
            clearTimeout(flashTimer);
            flashTimer = setTimeout(() => {
                el.style.display = "none";
            }, 8000);
        }

        document.getElementById("btn-save").addEventListener("click", async () => {
            const title = document.getElementById("song-title").value.trim();
            const link = document.getElementById("song-link").value.trim();
            const verse = document.getElementById("verse-ref").value.trim();

            if (!title || !selectedParashaId) {
                alert("Need song name + parasha");
                return;
            }
            if (verse.length > 60) {
                alert("Too much text, please just add the Chapter and Verse number");
                return;
            }

            let external_url = null;
            if (link) {
                if (!/^https?:\/\//i.test(link)) {
                    alert("URL must start with http:// or https://");
                    return;
                }
                try { new URL(link); external_url = link; } catch {
                    alert("Invalid URL format.");
                    return;
                }
            }

            const payload = {
                parasha_id: selectedParashaId,
                target_kind: selectedKind,
                song: { title, external_url },
                verse_ref: verse || null,
                ...(selectedKind === "haftarah" ? { target_id: selectedHaftarahId } : {})
            };

            try {
                const res = await fetch("/api/links", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data?.error || res.statusText);

                await loadLinksForCurrentSelection();

                document.getElementById("song-title").value = "";
                document.getElementById("song-link").value = "";
                document.getElementById("verse-ref").value = "";

                showFlash("Thank You for adding this song! You are amazing.");
            } catch (err) {
                alert("Save failed: " + err.message);
            }
        });
    </script>
</body>

</html>